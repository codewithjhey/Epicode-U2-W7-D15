<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Backofffice</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
      integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-6 mt-5">
          <h1>Movies</h1>

          <form onsubmit="onFormSubmit(event)" id="product-form">
            <div class="form-group">
              <label for="movie-name">Movie Name</label>
              <input type="text" class="form-control" id="movie-name" />
            </div>
            <div class="form-group">
              <label for="movie-description">Movie Description</label>
              <textarea class="form-control" id="movie-description"></textarea>
            </div>
            <div class="form-group">
              <label for="movie-category">Movie Category</label>
              <input type="text" class="form-control" id="movie-category" />
            </div>
            <div class="form-group">
              <label for="movie-imageUrl">Movie Image URL</label>
              <input type="url" class="form-control" id="movie-imageUrl" />
            </div>
            <button id="submit-button" type="submit" class="btn btn-primary">
              Upload Movie
            </button>
          </form>
        </div>
      </div>
    </div>
    <script>
      const params = new URLSearchParams(window.location.search)
      const movieId = params.get("movieId")

      window.onload = async () => {
        if (movieId) {
          const response = await fetch(
            `"https://striveschool-api.herokuapp.com/api/movies/action${movieId}`,
            {
              headers: {
                Authorization:
                  "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MzZjZjVlMGQ0YmUzZDAwMTU4NDYwMGEiLCJpYXQiOjE2NjgwODUyMTYsImV4cCI6MTY2OTI5NDgxNn0.wl5hBkD9sae_lwtheSJ5I9P5auDNRVFkknd2dmDiMsI"
              }
            }
          )
          const Movies = await response.json()

          let submitButton = document.querySelector("#submit-button")
          submitButton.innerText = "Edit product"
          submitButton.classList.remove("btn-primary")
          submitButton.classList.add("btn-success")

          document.querySelector("#product-name").value = movie.name
          document.querySelector("#product-description").value =
            movie.description
          document.querySelector("#product-brand").value = movie.brand
          document.querySelector("#product-imageUrl").value = movie.imageUrl
        }
      }

      async function onFormSubmit(event) {
        event.preventDefault()

        const newMovie = {
          name: document.querySelector("#movie-name").value,
          description: document.querySelector("#movie-description").value,
          brand: document.querySelector("#movie-brand").value,
          imageUrl: document.querySelector("#movie-imageUrl").value
        }

        const options = {
          method: movieId ? "PUT" : "POST",
          body: JSON.stringify(newMovie),
          headers: {
            "Content-Type": "application/json",
            Authorization:
              "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MzZjZjVlMGQ0YmUzZDAwMTU4NDYwMGEiLCJpYXQiOjE2NjgwODUyMTYsImV4cCI6MTY2OTI5NDgxNn0.wl5hBkD9sae_lwtheSJ5I9P5auDNRVFkknd2dmDiMsI"
          }
        }

        try {
          const endpoint = movieId
            ? `https://striveschool-api.herokuapp.com/api/movies/action${movieId}`
            : "https://striveschool-api.herokuapp.com/api/movies/action"

          const response = await fetch(endpoint, options)
          if (response.ok) {
            alert(
              movieId
                ? "Product is edited successfully!"
                : "Product is created successfully!"
            )
          } else {
            throw new Error("ERROR WHILE EXECUTING THE TRY BLOCK!")
          }
        } catch (error) {
          console.error(error)
        }
      }
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
